{"version":3,"sources":["../src/index.js"],"names":["app","use","getMe","req","token","headers","jwt","verify","process","env","SECRET","e","AuthenticationError","server","ApolloServer","introspection","playground","typeDefs","schema","resolvers","formatError","error","message","replace","context","connection","models","loaders","user","DataLoader","keys","batchUsers","me","secret","applyMiddleware","path","httpServer","http","createServer","installSubscriptionHandlers","eraseDatabaseOnSync","isTest","TEST_DATABASE","isProduction","DATABASE_URL","port","PORT","sequelize","sync","force","then","createUsersWithMessages","Date","listen","console","log","date","User","create","username","email","password","role","messages","text","createdAt","setSeconds","getSeconds","include","Message"],"mappings":"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","sourcesContent":["import express from \"express\";\r\n// Token generation\r\nimport jwt from \"jsonwebtoken\";\r\n// Import required modules for Apollo/GraphQL\r\nimport { ApolloServer, AuthenticationError } from \"apollo-server-express\";\r\nimport schema from \"./schema\";\r\nimport resolvers from \"./resolvers\";\r\nimport models, { sequelize } from \"./models\";\r\n// Allow for cross-domain request\r\nimport cors from \"cors\";\r\n// Allow transfer of data over HTTP\r\nimport http from \"http\";\r\nimport DataLoader from \"dataloader\";\r\nimport loaders from \"./loaders\";\r\n\r\n// set app variable to express main function\r\nconst app = express();\r\n\r\n// Allow cross domain request\r\napp.use(cors());\r\n\r\n// Set current user\r\nconst getMe = async (req) => {\r\n  // token from header\r\n  const token = req.headers[\"x-token\"];\r\n  // If token is found\r\n  if (token) {\r\n    // Verify token matches secret token\r\n    try {\r\n      return await jwt.verify(token, process.env.SECRET);\r\n    } catch (e) {\r\n      throw new AuthenticationError(\"Your session expired. Sign in again.\");\r\n    }\r\n  }\r\n};\r\n\r\n// Init apollo server with schema and resolvers\r\nconst server = new ApolloServer({\r\n  introspection: true,\r\n  playground: true,\r\n  typeDefs: schema,\r\n  resolvers,\r\n  formatError: (error) => {\r\n    // remove the internal sequelize error message\r\n    // leave only the important validation error\r\n    const message = error.message\r\n      .replace(\"SequelizeValidationError: \", \"\")\r\n      .replace(\"Validation error: \", \"\");\r\n\r\n    return {\r\n      ...error,\r\n      message,\r\n    };\r\n  },\r\n  context: async ({ req, connection }) => {\r\n    if (connection) {\r\n      return {\r\n        models,\r\n        loaders: {\r\n          user: new DataLoader((keys) => loaders.user.batchUsers(keys, models)),\r\n        },\r\n      };\r\n    }\r\n\r\n    if (req) {\r\n      const me = await getMe(req);\r\n\r\n      return {\r\n        models,\r\n        me,\r\n        secret: process.env.SECRET,\r\n        loaders: {\r\n          user: new DataLoader((keys) => loaders.user.batchUsers(keys, models)),\r\n        },\r\n      };\r\n    }\r\n  },\r\n});\r\n\r\n// Set API path\r\nserver.applyMiddleware({ app, path: \"/graphql\" });\r\n\r\n// Init http server to handle subscriptions\r\nconst httpServer = http.createServer(app);\r\nserver.installSubscriptionHandlers(httpServer);\r\n\r\n// Value to determine if database values should be reset\r\nconst eraseDatabaseOnSync = true;\r\n// Check if using testing database\r\nconst isTest = !!process.env.TEST_DATABASE;\r\n// Check if production database in use\r\nconst isProduction = !!process.env.DATABASE_URL;\r\n// Port based on prod or dev environment\r\nconst port = process.env.PORT || 8000;\r\n\r\n// Connect to postgres database through sequelize\r\nsequelize.sync({ force: isTest || isProduction }).then(async () => {\r\n  if (isTest || isProduction || eraseDatabaseOnSync) {\r\n    createUsersWithMessages(new Date());\r\n  }\r\n  // Listen on port based on prod or dev\r\n  httpServer.listen({ port }, () => {\r\n    console.log(`Apollo Server on http://localhost:${port}/graphql`);\r\n  });\r\n});\r\n\r\n// Clean database with each reload\r\nconst createUsersWithMessages = async (date) => {\r\n  await models.User.create(\r\n    {\r\n      username: \"rwieruch\",\r\n      email: \"hello@robin.com\",\r\n      password: \"rwieruch\",\r\n      role: \"ADMIN\",\r\n      messages: [\r\n        {\r\n          text: \"Published the Road to learn React\",\r\n          createdAt: date.setSeconds(date.getSeconds() + 1),\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      include: [models.Message],\r\n    }\r\n  );\r\n\r\n  await models.User.create(\r\n    {\r\n      username: \"ddavids\",\r\n      email: \"hello@david.com\",\r\n      password: \"ddavids\",\r\n      messages: [\r\n        {\r\n          text: \"Happy to release ...\",\r\n          createdAt: date.setSeconds(date.getSeconds() + 1),\r\n        },\r\n        {\r\n          text: \"Published a complete ...\",\r\n          createdAt: date.setSeconds(date.getSeconds() + 1),\r\n        },\r\n      ],\r\n    },\r\n    {\r\n      include: [models.Message],\r\n    }\r\n  );\r\n};\r\n"],"file":"index.js"}